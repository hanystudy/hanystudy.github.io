---
layout: post
status: publish
published: true
title: Visual C++动态链接库编程（六）
author: mp77
author_login: admin
author_email: 8621316@qq.com
wordpress_id: 32
wordpress_url: http://www.hanyi.name/blog/?p=32
date: 2008-04-05 15:19:07.000000000 +08:00
categories:
- 转载
tags:
- dll
- vc++
comments:
- id: 7536
  author: phentermine from custom hart
  author_email: gzqemqjp@hqlggygn.com
  author_url: http://trailfire.com/Phentermine_sample
  date: !binary |-
    MjAxMC0wNi0wNCAwNTozMzoxMCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wNi0wMyAyMTozMzoxMCArMDgwMA==
  content: <a href="http://www.azcentral.com/members/Blog/medecinesupply/84987" rel="nofollow">adipex
    diet pills safe</a> , [url="http://www.azcentral.com/members/Blog/medecinesupply/84987"]adipex
    diet pills safe[/url] , http://www.azcentral.com/members/Blog/medecinesupply/84987
    adipex diet pills safe ,
- id: 7571
  author: phentermine 37.5mg 90 tablets
  author_email: odqtexgt@muspmqbt.com
  author_url: http://phentermine4l124.webgarden.com/
  date: !binary |-
    MjAxMC0wNi0wNCAwNjowMzoxNSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wNi0wMyAyMjowMzoxNSArMDgwMA==
  content: <a href="http://community.miragespeakers.com/members/Tramadol-online-without-prescription.aspx"
    rel="nofollow">buy tramadol cod saturday delivery</a> , [url="http://community.miragespeakers.com/members/Tramadol-online-without-prescription.aspx"]buy
    tramadol cod saturday delivery[/url] , http://community.miragespeakers.com/members/Tramadol-online-without-prescription.aspx
    buy tramadol cod saturday delivery ,
- id: 7594
  author: drugs like xanax
  author_email: hbtxrrot@sbssjvwh.com
  author_url: http://technorati.com/people/xanaxd126m
  date: !binary |-
    MjAxMC0wNi0wNCAwNjoxOTowMiArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wNi0wMyAyMjoxOTowMiArMDgwMA==
  content: <a href="http://community.omnicom.no/members/Tramadol-reviews.aspx" rel="nofollow">tramadol
    and xanax experience</a> , [url="http://community.omnicom.no/members/Tramadol-reviews.aspx"]tramadol
    and xanax experience[/url] , http://community.omnicom.no/members/Tramadol-reviews.aspx
    tramadol and xanax experience ,
- id: 7647
  author: adipex drug testing
  author_email: couauphk@mupqkhuo.com
  author_url: http://community.omnicom.no/members/Adipex-online-pharmacy.aspx
  date: !binary |-
    MjAxMC0wNi0wNCAwNzozNTozMyArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wNi0wMyAyMzozNTozMyArMDgwMA==
  content: <a href="http://medecinesupply.socialgo.com/magazine/read/valium-without-rx_19.html"
    rel="nofollow">valium pros and cons</a> , [url="http://medecinesupply.socialgo.com/magazine/read/valium-without-rx_19.html"]valium
    pros and cons[/url] , http://medecinesupply.socialgo.com/magazine/read/valium-without-rx_19.html
    valium pros and cons ,
- id: 7939
  author: phentermine overn ight
  author_email: lgbeoluq@qpqvifnv.com
  author_url: http://www.thekartel.com/phentermine-online-2138m/
  date: !binary |-
    MjAxMC0wOC0wNiAyMTowNToxNiArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxMzowNToxNiArMDgwMA==
  content: Excellent site. It was pleasant to me.
- id: 8089
  author: xanax street value ohio
  author_email: czusulsd@cwgnsdyi.com
  author_url: http://soapitstop.com/members/Xanax-dosage.aspx
  date: !binary |-
    MjAxMC0wOC0wNiAyMjoxODozMiArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNDoxODozMiArMDgwMA==
  content: If you have to do it, you might as well do it right.
- id: 8117
  author: using paypal to buy tramadol
  author_email: untvvymr@ekvzdbpy.com
  author_url: http://connect.lehighvalleylive.com/user/tramadolb138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAyMjozMjoyMSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNDozMjoyMSArMDgwMA==
  content: Perfect site, i like it!
- id: 8348
  author: erectile dysfunction cialis
  author_email: dhyltxlm@batubzht.com
  author_url: http://www.urbanmoms.ca/mt/mt-cp.cgi?__mode=view&amp;blog_id=52&amp;id=28184
  date: !binary |-
    MjAxMC0wOC0wNyAwMDoyODoyMSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNjoyODoyMSArMDgwMA==
  content: Very interesting site. Hope it will always be alive!
- id: 8433
  author: xanax pay with mmastercard
  author_email: atbqconc@yasrxkjq.com
  author_url: http://www.starjuegos.com.ar/members/Xanax-price.aspx
  date: !binary |-
    MjAxMC0wOC0wNyAwMToxMToyNiArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNzoxMToyNiArMDgwMA==
  content: Very interesting site. Hope it will always be alive!
- id: 8551
  author: cialis with flomax
  author_email: jonojchd@tagbedfn.com
  author_url: http://connect.masslive.com/user/Cialis-Online-6138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMjowODo0NSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxODowODo0NSArMDgwMA==
  content: I want to say - thank you for this!
- id: 8583
  author: home made valium instructions
  author_email: adycikas@aujcller.com
  author_url: http://connect.advance.net/user/Valium-Online-v138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMjoyMzoyNiArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxODoyMzoyNiArMDgwMA==
  content: Excellent site. It was pleasant to me.
- id: 8643
  author: kipling somas
  author_email: llymlcyx@sycocvct.com
  author_url: http://connect.nj.com/user/Soma-Online-k138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMjo1MTozNSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxODo1MTozNSArMDgwMA==
  content: Very interesting site. Hope it will always be alive!
- id: 8821
  author: inexpensive viagra online
  author_email: rifdtwjs@suzpirwc.com
  author_url: http://connect.oregonlive.com/user/Viagra-Online-m150m/index.html
  date: !binary |-
    MjAxMC0wOS0yNCAxOTozMTo0MCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOS0yNCAxMTozMTo0MCArMDgwMA==
  content: I want to say - thank you for this!
---
　　动态链接库DLL实现了库的共享，体现了代码重用的思想。我们可以把广泛的、具有共性的、能够多次被利用的函数和类定义在库中。这样，在再次使用这些函数和类的时候，就不再需要重新添加与这些函数和类相关的代码。具有共性的问题大致有哪些呢？笔者归纳如下：
<p class="guanggao">　　（1）通用的算法</p>
　　图像处理、视频音频解码、压缩与解压缩、加密与解密通常采用某些特定的算法，这些算法较固定且在这类<a target="_blank" href="http://dev.yesky.com/" class="bluekey"><font color="#003399">程序</font></a>中往往经常被使用。

　　（2）纯资源DLL

　　我们可以从DLL中获取资源，对于一个支持多种语言的应用程序而言，我们可以判断<a target="_blank" href="http://os.yesky.com/" class="bluekey"><font color="#003399">操作系统</font></a>的语言，并自动为应用程序加载与OS对应的语言。这是多语言支持应用程序的一般做法。

　　（3）通信控制DLL

　　串口、网口的通信控制函数如果由DLL提供则可以使应用程序轻松不少。在工业控制、modem程序甚至socket通信中，经常使用通信控制DLL。

　　本节将给出DLL的三个典型应用实例。

　　<strong>7.1 算法DLL</strong>

　　我们直接用读者的一个提问作为例子。

　　宋宝华先生，您好！

　　我在dev.yesky.com上看到你连载的《VC++动态链接库编程》，觉得非常好。我以前主要是用Delphi的，C/C++学过，对Win32和VCL比较熟悉，但是没有接触过VC++，对MFC很陌生。这段时间和一个同学合作做光学成像的计算机模拟，用到傅立叶变换，手里面有例程是VC++写的。我们的界面是用Delphi开发，需要将其傅立叶变换功能提出做一个DLL供Delphi调用。苦于不懂MFC，试了很多方法，都不成功，最后只得采用折衷方案，简单修改一下程序，传一个参数进去，当作exe来调用，才没有耽搁后续进程。

　　……

　　谢谢！

　　　　　　　　致

　　礼！

　　　　　　　　 某某

　　学习过较高级别数学（概率统计与随机过程）、信号与线性系统及数字信号处理的读者应该知道，傅立叶变换是一种在信号分析中常用的算法，用于时域和频域的相互转换。FFT变换算法通用而有共性，我们适宜把它集成在一个DLL中。

　　随后，这位读者提供了这样的一个函数：
<table border="1" bgColor="#e3e3e3" align="center" width="90%" borderColor="#cccccc">
<tr>
<td>/* 函数名称：FFT()
* 参数:
* complex&lt;double&gt; * TD - 指向时域数组的指针
* complex&lt;double&gt; * FD - 指向频域数组的指针
* r －2的幂数，即迭代次数
* 返回值: 无。
* 说明:该函数用来实现快速傅立叶变换
*/void FFT(complex&lt;double&gt; * TD, complex&lt;double&gt; * FD, int r)
{
　LONG count; // 傅立叶变换点数
　int i,j,k; // 循环变量
　int bfsize,p; // 中间变量
　double angle; // 角度
　complex&lt;double&gt; *W,*X1,*X2,*X;
　count = 1 &lt;&lt; r; //傅立叶变换点数

　// 分配运算所需存储器

　W = new complex&lt;double&gt;[count / 2];
　X1 = new complex&lt;double&gt;[count];
　X2 = new complex&lt;double&gt;[count];

　// 计算加权系数

　for(i = 0; i &lt; count / 2; i++)
　{
　　angle = -i * PI * 2 / count;
　　W[i] = complex&lt;double&gt; (<a target="_blank" href="http://gamepic.yesky.com/gamepic/colplay/" class="bluekey"><font color="#003399">cos</font></a>(angle), sin(angle));
　}

　// 将时域点写入X1

　memcpy(X1, TD, sizeof(complex&lt;double&gt;) * count);

　// 采用蝶形算法进行快速傅立叶变换

　for(k = 0; k &lt; r; k++)
　{
　　for(j = 0; j &lt; 1 &lt;&lt; k; j++)
　　{
　　　bfsize = 1 &lt;&lt; (r-k);
　　　for(i = 0; i &lt; bfsize / 2; i++)
　　　{
　　　　p = j * bfsize;
　　　　X2[i + p] = X1[i + p] + X1[i + p + bfsize / 2];
　　　　X2[i + p + bfsize / 2] = (X1[i + p] - X1[i + p + bfsize / 2]) * W[i * (1&lt;&lt;k)];
　　　}
　　}
　　X = X1;
　　X1 = X2;
　　X2 = X;
　}

　// 重新排序

　for(j = 0; j &lt; count; j++)
　{
　　p = 0;
　　for(i = 0; i &lt; r; i++)
　　{
　　　if (j&amp;(1&lt;&lt;i))
　　　{
　　　　p+=1&lt;&lt;(r-i-1);
　　　}
　　}
　　FD[j]=X1[p];
　}

　// 释放内存

　delete W;
　delete X1;
　delete X2;
}</td>
</tr>
</table>
<p class="guanggao">　　既然有了FFT这个函数，我们要把它做在DLL中，作为DLL的一个接口将是十分简单的，其步骤如下：</p>
　　（1）利用MFC向导建立一个非MFC DLL；

　　（2）在工程中添加fft.h和fft.cpp两个文件；

　　fft.h的源代码为：
<table border="1" bgColor="#e3e3e3" align="center" width="90%" borderColor="#cccccc">
<tr>
<td>#ifndef FFT_H
#define FFT_H#include &lt;complex&gt;

using namespace std;
extern "C" void __declspec(dllexport) __stdcall FFT(complex&lt;double&gt; * TD, complex&lt;double&gt; * FD, int r);

#define PI 3.1415926
#endif

fft.cpp的源代码为：

/* 文件名：fft.cpp　*/

#include "fft.h"
void __stdcall FFT(complex&lt;double&gt; * TD, complex&lt;double&gt; * FD, int r)
{
　…//读者提供的函数代码
}</td>
</tr>
</table>
<p class="guanggao">　　在任何编程语言中使用Win32 API LoadLibrary都可以加载这个DLL，而使用GetProcAddress(hDll, "FFT")则可以获得函数FFT的地址，读者所提到的Delphi当然也不例外。</p>
　　这个DLL中有两点需要注意：

　　（1）使用extern "C"修饰函数声明，否则，生成的DLL只能供C++调用；

　　（2）使用__stdcall修饰函数声明及定义，__stdcall是Windows API的函数调用方式。
<p class="guanggao">　　<strong>7.2纯资源DLL</strong></p>
　　我们在应用<a target="_blank" href="http://dev.yesky.com/" class="bluekey"><font color="#003399">程序</font></a>中产生如图18所示的资源（对话框），<a target="_blank" href="http://www.mydown.com/code/244/244785.html"><font color="#d52b2b">单击此处下载本工程</font></a>。
<table border="0" align="center" width="90%">
<tr>
<td>
<p align="center"><img border="0" src="http://dev.yesky.com/imagelist/05/10/76j85iz4679p.jpg" />
图18 中文对话框</td>
</tr>
</table>
　　在与这个应用程序相同的工作区里利用MFC向导建立两个简单的DLL，把应用工程中的资源全选后分别拷贝到ChineseDll和EngLishDll，在EnglishDll工程的资源文件中搜索下面的语句：
<table border="1" bgColor="#e3e3e3" align="center" width="90%" borderColor="#cccccc">
<tr>
<td>/////////////////////////////////////////////////////////////////////////////// Chinese (P.R.C.) resources

#if !defined(AFX_RESOURCE_DLL) || defined(AFX_TARG_CHS)
#ifdef _WIN32
LANGUAGE LANG_CHINESE, SUBLANG_CHINESE_SIMPLIFIED
#pragma code_page(936)
#endif //_WIN32</td>
</tr>
</table>
　　将其改为：
<table border="1" bgColor="#e3e3e3" align="center" width="90%" borderColor="#cccccc">
<tr>
<td>/////////////////////////////////////////////////////////////////////////////
// English (U.S.) resources#if !defined(AFX_RESOURCE_DLL) || defined(AFX_TARG_ENU)
#ifdef _WIN32

LANGUAGE LANG_ENGLISH, SUBLANG_ENGLISH_US

#pragma code_page(1252)
#endif //_WIN32</td>
</tr>
</table>
　　并将其中所有的中文翻译为英文。这个DLL为我们提供了如图19所示的对话框资源。
<table border="0" align="center" width="90%">
<tr>
<td>
<p align="center"><img border="0" src="http://dev.yesky.com/imagelist/05/10/53b44x05f4i0.jpg" />
图19英文对话框</td>
</tr>
</table>
　　修改应用工程的InitInstance()函数，在
<table border="1" bgColor="#e3e3e3" align="center" width="90%" borderColor="#cccccc">
<tr>
<td>CResourceDllCallDlg dlg;
m_pMainWnd = &amp;dlg;
int nResponse = dlg.DoModal();</td>
</tr>
</table>
　　之前（即对话框显示之前）添加如下代码：
<table border="1" bgColor="#e3e3e3" align="center" width="90%" borderColor="#cccccc">
<tr>
<td>//获取<a target="_blank" href="http://os.yesky.com/" class="bluekey"><font color="#003399">操作系统</font></a>的语言WORD wLangPID = PRIMARYLANGID( GetSystemDefaultLangID() );
if( LANG_CHINESE == wLangPID )
{
　hLanguageDll = LoadLibrary( "ChineseDll.dll" ); //加载中文资源
}
else
{
　hLanguageDll = LoadLibrary( "EnglishDll.dll" ); //加载英文资源
}

if( NULL == hLanguageDll )
{
　AfxMessageBox( "Load DLL failure" );
　return FALSE;
}
AfxSetResourceHandle( hLanguageDll ); //设置当前的资源句柄</td>
</tr>
</table>
　　这样的应用程序将具有自适应性质，在中文OS中显示中文资源，在英文OS中则显示英文资源。
　　<strong>7.3通信控制DLL</strong>

　　我们在这里举一个串口通信类的例子。

　　也许您需要了解一点串口通信的背景知识，其实串口到处都看得到，譬如PC机的COM口即为串行通讯口（简称串口）。如图20，打开Windows的设备管理器，我们看到了COM口。

　　在Windows系统，需通过DCB(Device Control Block)对串口进行配置。利用Windows API GetCommState函数可以获取串口当前配置；利用SetCommState函数则可以设置串口通讯的参数。

　　串行通信通常按以下四步进行：

　　(1)打开串口；

　　(2)配置串口；

　　(3)数据传送；

　　(4)关闭串口。
<table border="0" align="center" width="90%">
<tr>
<td>
<p align="center"><img border="0" src="http://dev.yesky.com/imagelist/05/10/2b6sfwuq08kz.jpg" />
图20 PC的串口</td>
</tr>
</table>
　　由此可见，我们需要给串口控制DLL提供如下四个接口函数：
<table border="1" bgColor="#e3e3e3" align="center" width="90%" borderColor="#cccccc">
<tr>
<td>//打开指定的串口，其参数port为端口号BOOL ComOpen(int port); //在这个函数里使用默认的参数设置串口

//将打开的串口关闭

void ComClose(int port);

//将串口接收缓冲区中的数据放到buffer中

int GetComData(char *buf, int buf_len);

//将指定长度的数据发送到串口

int SendDataToCom(LPBYTE buf,int buf_Len);</td>
</tr>
</table>
　　下面给出了DLL接口的主要源代码框架：
<table border="1" bgColor="#e3e3e3" align="center" width="90%" borderColor="#cccccc">
<tr>
<td>//com.h：com类通信接口class AFX_EXT_CLASS com
{
　public:
　　ComOpen(int port)
　　{
　　　…
　　}
　　int SendDataToCom(LPBYTE buf,int buf_Len)
　　{
　　　…
　　}
　　int GetComData(char *buf, int buf_len)
　　{
　　　…
　　}
　　void ComClose()
　　{
　　　…
　　}
　}</td>
</tr>
</table>
　　我们编写一控制台<a target="_blank" href="http://dev.yesky.com/" class="bluekey"><font color="#003399">程序</font></a>来演示DLL的调用：
<table border="1" bgColor="#e3e3e3" align="center" width="90%" borderColor="#cccccc">
<tr>
<td>#include &lt;iostream&gt;
#include &lt;exception&gt;using namespace std;

#include &lt;windows.h&gt;
#include "com.h" //包含DLL中导出类的头文件 int main(int argc, char *argv[])
{
　try
　{
　　char str[] = "com_class test";
　　com com1;
　　com1.ComOpen (1);
　　for(int i=0; i&lt;100; i++) //以同步方式写com的buffer
　　{
　　　Sleep(500);
　　　com1.SendDataToCom (str,strlen(str));
　　}
　　com1.ComClose ();
　}
　catch(exception &amp;e)
　{
　　cout &lt;&lt; e.what() &lt;&lt; endl;
　}
　return 0;
}</td>
</tr>
</table>
　　DLL的编写与调用方法及主要应用皆已讲完，在下一节里，我们将看到比较“高深”的主题――DLL木马。曾几何时，DLL木马成为了病毒的一种十分重要的形式，是DLL的什么特性使得它能够成为一种病毒？下一节我们将揭晓谜底。
