---
layout: post
status: publish
published: true
title: JNI技术初步(四)
author: mp77
author_login: admin
author_email: 8621316@qq.com
wordpress_id: 104
wordpress_url: http://www.hanyi.name/blog/?p=104
date: 2008-10-18 16:31:47.000000000 +08:00
categories:
- 转载
- java
tags:
- Java
- jni
comments:
- id: 7535
  author: viagra vs cialis vs levitra
  author_email: arihkmvw@ebwjblit.com
  author_url: http://cialisrl124.webgarden.com/
  date: !binary |-
    MjAxMC0wNi0wNCAwNTozMTo1NCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wNi0wMyAyMTozMTo1NCArMDgwMA==
  content: <a href="http://ozgirl.tv/profile/Tramadolonlinepharmacy" rel="nofollow">tramadol
    sleepy</a> , [url="http://ozgirl.tv/profile/Tramadolonlinepharmacy"]tramadol sleepy[/url]
    , http://ozgirl.tv/profile/Tramadolonlinepharmacy tramadol sleepy ,
- id: 7554
  author: percription free phentermine
  author_email: vfvijjmg@hbxxdoac.com
  author_url: http://community.miragespeakers.com/members/Phentermine-without-rx-2010.aspx
  date: !binary |-
    MjAxMC0wNi0wNCAwNTo0ODo0MSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wNi0wMyAyMTo0ODo0MSArMDgwMA==
  content: <a href="http://medecinesupply.socialgo.com/magazine/read/phentermine-with-no-prescription_4.html"
    rel="nofollow">phentermine effects hormones</a> , [url="http://medecinesupply.socialgo.com/magazine/read/phentermine-with-no-prescription_4.html"]phentermine
    effects hormones[/url] , http://medecinesupply.socialgo.com/magazine/read/phentermine-with-no-prescription_4.html
    phentermine effects hormones ,
- id: 7593
  author: generic phentermine pills
  author_email: uqcfvamd@rchydkvo.com
  author_url: http://medecinesupply.socialgo.com/magazine/read/phentermine-forum_1.html
  date: !binary |-
    MjAxMC0wNi0wNCAwNjoxODoxNyArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wNi0wMyAyMjoxODoxNyArMDgwMA==
  content: <a href="http://forum.ywcasudbury.ca/members/Tramadol-online-without-prescription.aspx"
    rel="nofollow">cheap soma tramadol</a> , [url="http://forum.ywcasudbury.ca/members/Tramadol-online-without-prescription.aspx"]cheap
    soma tramadol[/url] , http://forum.ywcasudbury.ca/members/Tramadol-online-without-prescription.aspx
    cheap soma tramadol ,
- id: 7663
  author: kingsport tn phentermine
  author_email: jafttztp@pcbbktfm.com
  author_url: http://urhealth.mixxt.us/networks/blog/post.Tyler:3
  date: !binary |-
    MjAxMC0wNi0wOSAxMTo0MToyMyArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wNi0wOSAwMzo0MToyMyArMDgwMA==
  content: Beautiful site!
- id: 7763
  author: phentermine 30 mg free shipping
  author_email: moqbwbon@dbqgqcyj.com
  author_url: http://connect.cleveland.com/user/Phentermine-Online-1138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAxOTozODozMyArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxMTozODozMyArMDgwMA==
  content: If you have to do it, you might as well do it right.
- id: 7791
  author: phentermine patient work up forms
  author_email: utcnafux@hwjimqxy.com
  author_url: http://www.thekartel.com/phentermine-online-v138m/
  date: !binary |-
    MjAxMC0wOC0wNiAxOTo1MjoyOCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxMTo1MjoyOCArMDgwMA==
  content: I bookmarked this link. Thank you for good job!
- id: 7821
  author: qu bec cialis
  author_email: elamwbqg@mlktwnol.com
  author_url: http://connect.al.com/user/cialis8138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAyMDowNjo1NCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxMjowNjo1NCArMDgwMA==
  content: I bookmarked this link. Thank you for good job!
- id: 7850
  author: cardinal health tramadol on line
  author_email: wbflghez@hsxuembx.com
  author_url: http://connect.lehighvalleylive.com/user/tramadolb138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAyMDoyMTo0NyArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxMjoyMTo0NyArMDgwMA==
  content: It is the coolest site, keep so!
- id: 7881
  author: online doctor consultation adipex
  author_email: rehmxlfa@waeiwzqs.com
  author_url: http://connect.cleveland.com/user/Adipex-Online-m138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAyMDozNjoxMiArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxMjozNjoxMiArMDgwMA==
  content: Great. Now i can say thank you!
- id: 7912
  author: xanax habit forming
  author_email: eqqznnxc@okgcqoys.com
  author_url: http://www.urbanmoms.ca/mt/mt-cp.cgi?__mode=view&amp;blog_id=52&amp;id=28185
  date: !binary |-
    MjAxMC0wOC0wNiAyMDo1MDo0NSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxMjo1MDo0NSArMDgwMA==
  content: It is the coolest site, keep so!
- id: 7970
  author: tramadol without prescription cod
  author_email: vsjstraq@ttmnrcjb.com
  author_url: http://www.chicagohumanities.org/Profile/Bio.aspx?userid=e134c53e-7534-4135-a453-3d2761e53f69
  date: !binary |-
    MjAxMC0wOC0wNiAyMToyMDoyMyArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxMzoyMDoyMyArMDgwMA==
  content: Incredible site!
- id: 7998
  author: alcoholic equivalent to valium
  author_email: fgjqdedo@hwtltvrv.com
  author_url: http://connect.masslive.com/user/Valium-Online-8138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAyMTozNTo0MCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxMzozNTo0MCArMDgwMA==
  content: Incredible site!
- id: 8028
  author: adipex and vertigo
  author_email: udqilnso@mexhseze.com
  author_url: http://connect.nj.com/user/Adipex-Online-9138/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAyMTo0OTo0NSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxMzo0OTo0NSArMDgwMA==
  content: Great work, webmaster, nice design!
- id: 8058
  author: does adipex have ephedra in it
  author_email: amfhsvdr@yfhduway.com
  author_url: http://connect.lehighvalleylive.com/user/adipexj138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAyMjowMzo0OCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNDowMzo0OCArMDgwMA==
  content: Great. Now i can say thank you!
- id: 8145
  author: best cheap tramadol
  author_email: xzqdnpfn@ppswsyds.com
  author_url: http://www.thekartel.com/tramadol-online-9138m/
  date: !binary |-
    MjAxMC0wOC0wNiAyMjo0NzowNCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNDo0NzowNCArMDgwMA==
  content: Beautiful site!
- id: 8174
  author: tramadol hydrochloride for canines
  author_email: dirrrnsq@yrilyzvh.com
  author_url: http://www.chicagohumanities.org/Profile/Bio.aspx?userid=33363021-8b6b-4484-9524-d0a615667d31
  date: !binary |-
    MjAxMC0wOC0wNiAyMzowMTozNSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNTowMTozNSArMDgwMA==
  content: Beautiful site!
- id: 8204
  author: phentermine powered by bloglines
  author_email: ueputjfv@irbdgfaj.com
  author_url: http://soapitstop.com/members/cheap-Phentermine-pills.aspx
  date: !binary |-
    MjAxMC0wOC0wNiAyMzoxNjowMyArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNToxNjowMyArMDgwMA==
  content: Excellent site. It was pleasant to me.
- id: 8232
  author: herbal equivalent of valium
  author_email: thgpbbqv@fxnzvdbg.com
  author_url: http://connect.masslive.com/user/Valium-Online-8138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAyMzozMDozNSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNTozMDozNSArMDgwMA==
  content: I bookmarked this link. Thank you for good job!
- id: 8260
  author: prescription tramadol 3
  author_email: fagsetxw@morcbmar.com
  author_url: http://connect.cleveland.com/user/Tramadol-Online-o138/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAyMzo0NToxMCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNTo0NToxMCArMDgwMA==
  content: Great. Now i can say thank you!
- id: 8288
  author: does xanax slow your metabolism
  author_email: nvvnycer@btbkqdcp.com
  author_url: http://connect.pennlive.com/user/Xanax-Online-d138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNiAyMzo1OTozMiArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNTo1OTozMiArMDgwMA==
  content: Great site. Keep doing.
- id: 8317
  author: phentermine 30mg e5000
  author_email: vsadzxps@qpvrykhd.com
  author_url: http://www.thekartel.com/phentermine-online-v138m/
  date: !binary |-
    MjAxMC0wOC0wNyAwMDoxNDowNSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNjoxNDowNSArMDgwMA==
  content: It is the coolest site, keep so!
- id: 8376
  author: cheap adipex pills
  author_email: dlveaoeu@seyixuqr.com
  author_url: http://connect.nola.com/user/Adipex-Online-k138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMDo0MjozMyArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNjo0MjozMyArMDgwMA==
  content: I bookmarked this link. Thank you for good job!
- id: 8404
  author: cheapest phentermine free shipping
  author_email: bclmilre@difkzadb.com
  author_url: http://connect.nola.com/user/Phentermine-Online-8138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMDo1Njo1NSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNjo1Njo1NSArMDgwMA==
  content: Beautiful site!
- id: 8463
  author: tramadol pounds online
  author_email: ixstwhkp@ivjwosos.com
  author_url: http://www.thekartel.com/tramadol-online-5138m/
  date: !binary |-
    MjAxMC0wOC0wNyAwMToyNjoxOCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNzoyNjoxOCArMDgwMA==
  content: Great work, webmaster, nice design!
- id: 8493
  author: canadian cheap adipex
  author_email: datskfce@zacvfjpw.com
  author_url: http://connect.pennlive.com/user/Adipex-Online-5138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMTo0MDoxNiArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNzo0MDoxNiArMDgwMA==
  content: Excellent site. It was pleasant to me.
- id: 8522
  author: celebrex metrogel tramadol cialis
  author_email: yauuqmuv@kqudnsxl.com
  author_url: http://connect.al.com/user/cialisg138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMTo1NDo0NCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxNzo1NDo0NCArMDgwMA==
  content: Great site. Keep doing.
- id: 8550
  author: xanax trip report
  author_email: iguhuaef@hvblzist.com
  author_url: http://connect.advance.net/user/Xanax-Online-a138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMjowODo0NSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxODowODo0NSArMDgwMA==
  content: It is the coolest site, keep so!
- id: 8612
  author: tramadol hydrochloride dosing
  author_email: tlektkio@buvqqwom.com
  author_url: http://www.starjuegos.com.ar/members/Tramadol-side-effects.aspx
  date: !binary |-
    MjAxMC0wOC0wNyAwMjozNzo0MCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxODozNzo0MCArMDgwMA==
  content: I bookmarked this link. Thank you for good job!
- id: 8642
  author: xanax g 3721
  author_email: rcuhnojl@fbqqsgof.com
  author_url: http://connect.masslive.com/user/Xanax-Online-t138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMjo1MTozNCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxODo1MTozNCArMDgwMA==
  content: Great site. Good info.
- id: 8674
  author: viagra generico
  author_email: rdjpodlm@whcwzpbl.com
  author_url: http://www.thekartel.com/viagra-online-k138m/
  date: !binary |-
    MjAxMC0wOC0wNyAwMzowNjowOCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxOTowNjowOCArMDgwMA==
  content: Great. Now i can say thank you!
- id: 8703
  author: purchase adipex online $139 without prescription
  author_email: gtuyjifa@xdxlwhyj.com
  author_url: http://connect.cleveland.com/user/Adipex-Online-8138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMzoyMDozOSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxOToyMDozOSArMDgwMA==
  content: I want to say - thank you for this!
- id: 8736
  author: diazepam or valium
  author_email: scnmwqoo@izhbgqfp.com
  author_url: http://connect.lehighvalleylive.com/user/valiume138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMzozNToxMiArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxOTozNToxMiArMDgwMA==
  content: Excellent site. It was pleasant to me.
- id: 8767
  author: length of tramadol withdrawal sleeplessness
  author_email: pctpemig@ifubhtuf.com
  author_url: http://connect.lehighvalleylive.com/user/tramadolu138m/index.html
  date: !binary |-
    MjAxMC0wOC0wNyAwMzo0OTozNyArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0wNiAxOTo0OTozNyArMDgwMA==
  content: Incredible site!
- id: 8797
  author: adipex and heart
  author_email: kolajumf@qfeankyz.com
  author_url: http://www.nonelouder.com/profile/Adipexreviews289
  date: !binary |-
    MjAxMC0wOC0yMSAwNToyNjowNCArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOC0yMCAyMToyNjowNCArMDgwMA==
  content: Very interesting site. Hope it will always be alive!
- id: 8809
  author: url buy phentermine online
  author_email: kkwuaniu@eeqqkjkw.com
  author_url: http://www.wikisandbox.com/account/Phentermine-Online-v
  date: !binary |-
    MjAxMC0wOS0wNSAxNzo1ODowOSArMDgwMA==
  date_gmt: !binary |-
    MjAxMC0wOS0wNSAwOTo1ODowOSArMDgwMA==
  content: Perfect work!
---
//返回一个结构数组，返回一个硬盘信息的结构数组
JNIEXPORT jobjectArray JNICALL Java_com_sundy_jnidemo_ChangeMethodFromJni_getStructArray
(JNIEnv *env, jobject _obj)
{
//申明一个object数组
jobjectArray args = 0;

//数组大小
jsize len = 5;

//获取object所属类,一般为ava/lang/Object就可以了
jclass objClass = (env)-&gt;FindClass("java/lang/Object");

//新建object数组
args = (env)-&gt;NewObjectArray(len, objClass, 0);

/**//* 下面为获取到Java中对应的实例类中的变量*/

//获取Java中的实例类
jclass objectClass = (env)-&gt;FindClass("com/sundy/jnidemo/DiskInfo");

//获取类中每一个变量的定义
//名字
jfieldID str = (env)-&gt;GetFieldID(objectClass,"name","Ljava/lang/String;");
//序列号
jfieldID ival = (env)-&gt;GetFieldID(objectClass,"serial","I");

//给每一个实例的变量付值，并且将实例作为一个object，添加到objcet数组中
for(int i=0; i &lt; len; i++ )
{
//给每一个实例的变量付值
jstring jstr = WindowsTojstring(env,"我的磁盘名字是 D:");
//(env)-&gt;SetObjectField(_obj,str,(env)-&gt;NewStringUTF("my name is D:"));
(env)-&gt;SetObjectField(_obj,str,jstr);
(env)-&gt;SetShortField(_obj,ival,10);

//添加到objcet数组中
(env)-&gt;SetObjectArrayElement(args, i, _obj);
}
//返回object数组
return args;

}

//将jstring类型转换成windows类型
char* jstringToWindows( JNIEnv *env, jstring jstr )
{
int length = (env)-&gt;GetStringLength(jstr );
const jchar* jcstr = (env)-&gt;GetStringChars(jstr, 0 );
char* rtn = (char*)malloc( length*2+1 );
int size = 0;
size = WideCharToMultiByte( CP_ACP, 0, (LPCWSTR)jcstr, length, rtn,(length*2+1), NULL, NULL );
if( size &lt;= 0 )
return NULL;
(env)-&gt;ReleaseStringChars(jstr, jcstr );
rtn[size] = 0;
return rtn;
}
//将windows类型转换成jstring类型
jstring WindowsTojstring( JNIEnv* env, char* str )
{
jstring rtn = 0;
int slen = strlen(str);
unsigned short * buffer = 0;
if( slen == 0 )
rtn = (env)-&gt;NewStringUTF(str );
else
{
int length = MultiByteToWideChar( CP_ACP, 0, (LPCSTR)str, slen, NULL, 0 );
buffer = (unsigned short *)malloc( length*2 + 1 );
if( MultiByteToWideChar( CP_ACP, 0, (LPCSTR)str, slen, (LPWSTR)buffer, length ) &gt;0 )
rtn = (env)-&gt;NewString( (jchar*)buffer, length );
}
if( buffer )
free( buffer );
return rtn;
}

Java 测试native代码
这没有什么多说的，看代码吧
//主测试程序
public static void main(String[] args) {
ChangeMethodFromJni changeJni = new ChangeMethodFromJni();

//输入常用的数值类型(string int boolean)
System.out
.println("------------------输入常用的数值类型(string int boolean)-----------");
changeJni.displayParms("Hello World!", 100, true);

//调用一个静态方法
System.out.println("------------------调用一个静态方法-----------");
int ret = changeJni.add(12, 20);
System.out.println("The result is: " + String.valueOf(ret));

//输入一个数组
System.out.println("------------------输入一个数组-----------");
boolean[] blList = new boolean[] { true, false, true };
changeJni.setArray(blList);

//返回一个字符串数组
System.out.println("------------------返回一个字符串数组-----------");
String[] strList = changeJni.getStringArray();
for (int i = 0; i &lt; strList.length; i++) {
System.out.print(strList[i]);
}
System.out.println();

System.out.println("------------------返回一个结构-----------");

//返回一个结构
DiskInfo disk = changeJni.getStruct();
System.out.println("name:" + disk.name);
System.out.println("Serial:" + disk.serial);

//返回一个结构数组

System.out.println("------------------返回一个结构数组 -----------");
DiskInfo[] diskList = changeJni.getStructArray();
for (int i = 0; i &lt; diskList.length; i++) {
System.out.println("name:" + diskList[i].name);
System.out.println("Serial:" + diskList[i].serial);
}

}
注:本程序在VS2003,eclipse (jse5.0) winxp sp2编译通过
